#!/bin/bash
cat > /home/ec2-user/.ssh/id_rsa <<EOF
-----BEGIN RSA PRIVATE KEY-----
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
-----END RSA PRIVATE KEY-----
EOF
sudo chmod 600 /home/ec2-user/.ssh/id_rsa
sudo su -
cp /home/ec2-user/.ssh/id_rsa /root/.ssh/id_rsa
chmod 600 /root/id_rsa
chown -RH ec2-user:ec2-user /home/ec2-user/.ssh/id_rsa
amazon-linux-extras install ansible2 -y
cd /root
cat > boto3.yaml <<-END
---
- hosts: localhost
  become: yes

  tasks:
    - name: install pip
      yum:
        name:
          - python-pip
          - python3-pip
        state: latest

    - name: install boto
      pip:
        name:
          - boto
          - boto3
END
ansible-playbook boto3.yaml
aws configure set aws_access_key_id AKIA2UICVQQCSGQAOWNS
aws configure set aws_secret_access_key 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
yum install -y git
git clone https://github.com/jump99500/TeamCada_Ansible.git /root/ansible
cp /root/.ssh/id_rsa /root/ansible
cd ansible
ansible-playbook httpd.yaml
ansible-playbook tomcat.yaml
ansible-playbook bastion_ebs_mount.yaml
amazon-linux-extras enable java-openjdk11
yum install -y java-11-openjdk-devel.x86_64
cat >> /etc/profile <<-ENQ

export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-11.0.12.0.7-0.amzn2.0.2.x86_64
export PATH=$PATH:$JAVA_HOME/bin
ENQ
source /etc/profile
wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo
rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key
amazon-linux-extras enable epel
yum install epel-release -y
yum install -y jenkins
sed -i 's/JENKINS_PORT="8080"/JENKINS_PORT="60010"/g' /etc/sysconfig/jenkins
systemctl start jenkins
sudo cat  >> /etc/sudoers<<-ENS
jenkins         ALL=(ALL)       NOPASSWD: ALL
ENS

#s3_log_upload.yaml을 실행
cat >> /root/ansible/s3_log.sh<<-ESE
#!/bin/bash
sudo su -
cd /root/ansible
ansible-playbook s3_log_upload.yaml
ESE
chmod u+x /root/ansible/s3_log.sh

#매일 매시간 0분, 20분, 40분마다 s3_log,sh를 실행
cat >> /etc/crontab<<-EFC
0,20,40 * * * 0-6 root /root/ansible/s3_log.sh
EFC
